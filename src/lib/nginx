# -----------------------------------
# app.fabform.io - SPA with fallback
# -----------------------------------
server {
    listen 443 ssl http2;
    server_name app.fabform.io;

    root /var/www/fabform-app/dist;  # Your SPA build directory
    index index.html;

    location / {
        # Serve SPA with fallback to index.html for client-side routing
        try_files $uri $uri/ /index.html;
    }

    ssl_certificate /etc/letsencrypt/live/fabform.io-0007/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/fabform.io-0007/privkey.pem;
}

server {
    listen 80;
    server_name app.fabform.io;
    return 301 https://$host$request_uri;
}

# -----------------------------------
# fabform.io - static + proxy for SPA routes and assets
# -----------------------------------
server {
    listen 443 ssl http2;
    server_name fabform.io www.fabform.io;

    root /var/www/fabform-static-site/dist;  # Static site root (for other routes)
    index index.html;

    # Proxy /v/* requests to app.fabform.io root, stripping /v prefix
    location /v/ {
        proxy_pass https://app.fabform.io/;
        proxy_set_header Host app.fabform.io;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_ssl_server_name on;
        proxy_ssl_verify off;  # Remove in production!
    }

    # Proxy /assets/* requests to app.fabform.io assets for SPA static files
    location /assets/ {
        proxy_pass https://app.fabform.io/assets/;
        proxy_set_header Host app.fabform.io;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_ssl_server_name on;
        proxy_ssl_verify off;  # Remove in production!
    }

    # Serve other static files locally or return 404
    location / {
        try_files $uri $uri/ =404;
    }

    ssl_certificate /etc/letsencrypt/live/fabform.io-0007/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/fabform.io-0007/privkey.pem;
}

server {
    listen 80;
    server_name fabform.io www.fabform.io;
    return 301 https://$host$request_uri;
}
